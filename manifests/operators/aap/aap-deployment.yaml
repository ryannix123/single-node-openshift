# Ansible Automation Platform 2.6 Deployment
# 
# Apply in stages (CRDs don't exist until operator installs):
#   Stage 1: oc apply -f aap-deployment.yaml -l stage=1
#   Wait:    oc get crd | grep ansible (wait for CRDs)
#   Stage 2: oc apply -f aap-deployment.yaml -l stage=2
#
# Access:
#   Route: oc get routes -n aap (use the 'aap' gateway route, NOT 'controller')
#   Password: oc get secret aap-admin-password -n aap -o jsonpath='{.data.password}' | base64 -d
#   Username: admin

---
# Stage 1: Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: aap
  labels:
    stage: "1"

---
# Stage 1: OperatorGroup
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: aap-operator-group
  namespace: aap
  labels:
    stage: "1"
spec:
  targetNamespaces:
    - aap

---
# Stage 1: Subscription
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: ansible-automation-platform-operator
  namespace: aap
  labels:
    stage: "1"
spec:
  channel: stable-2.6
  installPlanApproval: Automatic
  name: ansible-automation-platform-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace

---
# Stage 2: AnsibleAutomationPlatform
# This creates the unified gateway that handles authentication
# The gateway route is what you use to access the UI
apiVersion: aap.ansible.com/v1alpha1
kind: AnsibleAutomationPlatform
metadata:
  name: aap
  namespace: aap
  labels:
    stage: "2"
spec:
  gateway:
    replicas: 1
  controller:
    disabled: false
  # Disable hub/eda to save resources on SNO
  hub:
    disabled: true
  eda:
    disabled: true
